@page "/user"
@page "/user/login"
@inject IJSRuntime js
@using oswald_online_shop.Data
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navManager
@layout Simple;

<AuthorizeView>
  <Authorized>

    <div class="min-h-screen flex flex-col mt-26 items-center space-y-4">
      <h3 class="text-2xl font-normal text-red-400">Ya estas autoriazdo para accerder a esta ruta </h3>

      <div class="relative inset-x-0 flex justify-center group">
        <span
          class="absolute  bg-indigo-500 w-36 rounded-lg transform translate-x-9 translate-y-6 h-12 transition duration-500 group-hover:translate-y-0 group-hover:translate-x-0"></span>

        <span
          class="absolute  bg-black w-44 rounded-lg group-hover:translate-x-0 transform translate-x-3 translate-y-3.5 group-hover:translate-y-0 h-12 transition duration-500"></span>

        <a class="relative text-blue-300 w-44 text-center rounded-lg text-xl cursor-pointer bg-white shadow-xl px-3 py-3 group-hover:bg-slate-800 group-hover:text-white transition duration-500 font-semibold"
          href="/productlist ">Volver al inicio</a>
      </div>
    </div>
  </Authorized>
  <NotAuthorized>

    @if (@msg != "")
    {
      <div class="w-full top-1 mx-auto absolute top-0 flex justify-center ">
        <div class="absolute w-1/4 bg-red-400 py-3 border-b-4 border-red-600 rounded-md">
          <div class="flex justify-center items-center">
            <h1 class="text-center text-white font-semibold">@msg</h1>

            <button @onclick="message"
            class="ml-5 bg-red-500 rounded-full w-5 hover:rotate-45 transition duration-500"><svg
              class="fill-current h-5 text-white hover:rotate-45 transition duration-500 "
              xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                <path
                d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z" />
              </svg></button>

          </div>

        </div>
      </div>


    }

    <div class="w-full">


      <div
        class="bg-white mx-auto rounded-2xl border shadow-x1 p-10 max-w-lg shadow-lg hover:shadow-2xl transition duration-300 mt-24 ">
        <div class="flex flex-col items-center space-y-4">
          <h1 class="font-bold text-2xl text-gray-700 w-4/6 text-center">
            Inicio de sesion
          </h1><svg class="h-16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
            <path
              d="M176 448C167.3 448 160 455.3 160 464V512h32v-48C192 455.3 184.8 448 176 448zM272 448c-8.75 0-16 7.25-16 16s7.25 16 16 16s16-7.25 16-16S280.8 448 272 448zM164 172l8.205 24.62c1.215 3.645 6.375 3.645 7.59 0L188 172l24.62-8.203c3.646-1.219 3.646-6.375 0-7.594L188 148L179.8 123.4c-1.215-3.648-6.375-3.648-7.59 0L164 148L139.4 156.2c-3.646 1.219-3.646 6.375 0 7.594L164 172zM336.1 315.4C304 338.6 265.1 352 224 352s-80.03-13.43-112.1-36.59C46.55 340.2 0 403.3 0 477.3C0 496.5 15.52 512 34.66 512H128v-64c0-17.75 14.25-32 32-32h128c17.75 0 32 14.25 32 32v64h93.34C432.5 512 448 496.5 448 477.3C448 403.3 401.5 340.2 336.1 315.4zM64 224h13.5C102.3 280.5 158.4 320 224 320s121.8-39.5 146.5-96H384c8.75 0 16-7.25 16-16v-96C400 103.3 392.8 96 384 96h-13.5C345.8 39.5 289.6 0 224 0S102.3 39.5 77.5 96H64C55.25 96 48 103.3 48 112v96C48 216.8 55.25 224 64 224zM104 136C104 113.9 125.5 96 152 96h144c26.5 0 48 17.88 48 40V160c0 53-43 96-96 96h-48c-53 0-96-43-96-96V136z" />
          </svg>
          <input type="email" @bind="username" placeholder="Nombre de usuario o correo electronico"
            class="border-2 rounded-lg w-full h-12 px-4 outline-none" />
          <input type="password" @bind="pwd" placeholder="Contrasena"
            class="border-2 rounded-lg w-full h-12 px-4 outline-none" />
          <button
            class="bg-red-400 text-white rounded-md hover:bg-red-500 font-semibold px-4 py-3 w-full border-4 border-transparent hover:border-red-500 transition duration-300 text-xl"
            @onclick="auth">
            Iniciar Sesion
          </button>
        </div>
      </div>

    </div>
  </NotAuthorized>
</AuthorizeView>



@code {
  private string username { get; set; }
  private string pwd { get; set; }
  private string role { get; set; }

  private User user = new User();
  private bool collapseNavMenu = true;

  private string? view => collapseNavMenu ? "password" : "text";
  private string msg = "";
  void message()
  {
    msg = "";
  }
  private void viewPassword()
  {
    collapseNavMenu = !collapseNavMenu;
  }

  private bool verificacionUser()
  {
    using (var db = new MyDBContext())
    {

      var query = from r in db.Users
                  where r.username == this.username && r.pwd == this.pwd
                  select r;
      return query.Any();
    }
  }

  private bool verificacionAdmin()
  {
    using (var db = new MyDBContext())
    {

      var query = from r in db.Admins
                  where r.username == this.username && r.pwd == this.pwd
                  select r;
      return query.Any();
    }
  }
  private async Task auth()
  {
    if (verificacionAdmin())
    {
      role = "admin";
      await crearSession(role);
      navManager.NavigateTo("/ProductList", true);

    }else if(verificacionUser()){
      role = "user";

      await crearSession(role);
      navManager.NavigateTo("/ProductList", true);
    }
    else
    {
      Console.WriteLine("No esta este nombre de usuario");
      msg = "Usuario o contraseÃ±a incorrectos";
      return;
    }
  }

public  void retornar_id_personal(){
  using (var db = new MyDBContext())
  {
    var query = db.Users.Where(s => s.username == username).ToList();
    foreach (var item in query)
    {
      Console.WriteLine(item.id);
      
    }
  }
}
  public async Task crearSession(string role){
      var auth = (Authen)authStateProvider;
      await auth.UpdateAuthenticationState(new UserSession
      {
        UserName = username,
        Role = role
      });
  }
}