@page "/user"
@page "/user/login"
@inject IJSRuntime js
@using oswald_online_shop.Data
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navManager
@layout Simple;

<AuthorizeView>



<Authorized>

<div class="min-h-screen flex flex-col mt-26 items-center space-y-4" >
<h3 class="text-2xl font-normal text-red-400">Ya estas autoriazdo para accerder a esta ruta </h3>

<div class="relative inset-x-0 flex justify-center group">
    <span class="absolute  bg-indigo-500 w-36 rounded-lg transform translate-x-9 translate-y-6 h-12 transition duration-500 group-hover:translate-y-0 group-hover:translate-x-0"></span>

  <span class="absolute  bg-black w-44 rounded-lg group-hover:translate-x-0 transform translate-x-3 translate-y-3.5 group-hover:translate-y-0 h-12 transition duration-500"></span>

<a class="relative text-blue-300 w-44 text-center rounded-lg text-xl cursor-pointer bg-white shadow-xl px-3 py-3 group-hover:bg-slate-800 group-hover:text-white transition duration-500 font-semibold" href="/productlist ">Volver al inicio</a>
</div>
</div>
</Authorized>
<NotAuthorized>

    @if (@msg != "")
            {
                <div class="w-full top-1 mx-auto absolute top-0 flex justify-center ">
                    <div class="absolute w-1/4 bg-red-400 py-3 border-b-4 border-red-600 rounded-md">
                    <div class="flex justify-center items-center">
                                                <h1 class="text-center text-white font-semibold">@msg</h1>

                                                <button @onclick="message" class="ml-5 bg-red-500 rounded-full w-5 hover:rotate-45 transition duration-500"><svg class="fill-current h-5 text-white hover:rotate-45 transition duration-500 "xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg></button>

                    </div>

                    </div>
                </div>


            }

     <div class="w-80 bg-white rounded-3xl mr-auto ml-auto hover:shadow-2xl transition duration-300 overflow-hidden shadow-xl ">

        <div class="px-10 pt-4 pb-8 bg-white dark:bg-gray-800 rounded-tr-4xl">
          <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 text-center">Iniciar sesion</h1>
          <div class="mt-12">
            <div class="relative">
              <input id="email" name="email" type="text" class="peer h-10 w-full border-b-2 border-gray-300 text-gray-900 dark:bg-gray-800 placeholder-transparent dark:text-gray-100 focus:outline-none focus:border-rose-600" placeholder="john@doe.com" @bind="username"/>
              <label for="email" class="absolute left-0 -top-3.5 text-gray-600 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-2 peer-focus:-top-3.5 peer-focus:text-gray-600 peer-focus:text-sm">Correo electronico</label>
            </div>
            <div class="mt-10 relative">
              <input id="password" type="@view" name="password" class="peer h-10 w-full border-b-2 border-gray-300 text-gray-900 dark:bg-gray-800 placeholder-transparent focus:outline-none dark:text-gray-100 focus:border-rose-600" placeholder="Password" @bind="pwd" />
              <span @onclick="viewPassword">
<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-black dark:text-gray-100 absolute bottom-0.5 right-2 " fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
  <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
</svg>
</span>
              <label for="password" class="absolute left-0 -top-3.5 text-gray-600 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-2 peer-focus:-top-3.5 peer-focus:text-gray-600 peer-focus:text-sm dark:text-gray-100">contraseña</label>
            </div>

            <button  @onclick="auth" class="mt-20 px-4 py-2 rounded-lg bg-rose-500 hover:bg-rose-400 text-white font-semibold text-center block w-full focus:outline-none focus:ring focus:ring-offset-2 focus:ring-rose-500 focus:ring-opacity-80 cursor-pointer" >Iniciar Sesion</button>
          </div>
          <div class="flex flex-col">
          <a href="#" class="mt-4 block text-sm text-center font-medium text-gray-600 hover:underline focus:outline-none focus:ring-2 focus:ring-rose-500 dark:text-gray-100"> ¿Olvidaste tu contraseña? </a>


                    <a href="user/register" class="mt-4 block text-sm text-center font-medium text-gray-600 hover:underline focus:outline-none focus:ring-2 focus:ring-rose-500 dark:text-gray-100">¿No tienes cuenta?</a>

                    <a href="/" class="mt-4 block text-sm text-center font-medium text-gray-600 hover:underline focus:outline-none focus:ring-2 focus:ring-rose-500 dark:text-gray-100">Volver</a>
                    </div>

        </div>
      </div>
      </NotAuthorized>
</AuthorizeView>



@code{
  private string username {get; set;}
  private string pwd {get; set;}

      private User user = new User();
    private bool collapseNavMenu = true;

    private string? view => collapseNavMenu ? "password" : "text";
    private string msg ="";
void message(){
  msg = "";
}
    private void viewPassword()
    {
        collapseNavMenu = !collapseNavMenu;
    }

private bool verificacion (){
  using(var db = new MyDBContext()){

            var query = from r in db.Users
                        where r.username == this.username && r.pwd == this.pwd
                        select r;
             return query.Any();
  }
}

    private async Task auth()
    {

      if(verificacion()){

        var auth = (Authen)authStateProvider;
            Console.WriteLine(await auth.GetAuthenticationStateAsync());

        await auth.UpdateAuthenticationState(new UserSession{
        UserName = username,
        Role = "admin"
        });

        navManager.NavigateTo("/ProductList",true);

      }else{
        Console.WriteLine("No esta este nombre de usuario");
          msg = "Usuario o contraseña incorrectos";
            return;
    }
    }
      }